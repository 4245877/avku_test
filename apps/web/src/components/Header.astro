---
// src/components/Header.astro
import styles from "./Header.module.css";

const navItems = [
  { href: "/", key: "nav_home", label: "Головна" },
  { href: "/about", key: "nav_about", label: "Про нас" },
  { href: "/events", key: "nav_events", label: "Події" },
  { href: "/news", key: "nav_news", label: "Новини" },
  { href: "/publications", key: "nav_publications", label: "Публікації" },
  { href: "/reports", key: "nav_reports", label: "Звіти" },
  { href: "/donate", key: "nav_donate", label: "Підтримати" },
  { href: "/contacts", key: "nav_contacts", label: "Контакти" },
];

const pathname = Astro.url?.pathname ?? "/";
const normalize = (p) => (p.length > 1 && p.endsWith("/") ? p.slice(0, -1) : p);
const current = normalize(pathname);

const isActive = (href) => {
  const h = normalize(href);
  return h === "/" ? current === "/" : current === h || current.startsWith(h + "/");
};
---

<header class={`${styles.header} header`} id="main-header">
  <nav class={`${styles.navbar} navbar`} aria-label="Primary navigation">
    <div class={`${styles.logo} logo`}>
      <a class={`${styles.logoLink} logo-link`} href="/" data-translate="Association">АВКУ</a>
    </div>

    {/* Я сгруппировал мобильные элементы управления для лучшего позиционирования */}
    <div class={styles.mobileControls}>
        <div class={`${styles.languageSelector} language-selector`} aria-label="Language selector">
          <button type="button" class={`${styles.langBtn} lang-btn`} data-lang="en">EN</button>
          <button type="button" class={`${styles.langBtn} lang-btn`} data-lang="uk">UA</button>
        </div>

        <button
          type="button"
          class={`${styles.hamburger} hamburger`}
          aria-label="Toggle menu"
          aria-controls="primary-nav"
          aria-expanded="false"
        >
          <span class={`${styles.hamburgerLine} hamburger-line`}></span>
          <span class={`${styles.hamburgerLine} hamburger-line`}></span>
          <span class={`${styles.hamburgerLine} hamburger-line`}></span>
        </button>
    </div>

    <ul class={`${styles.navLinks} nav-links`} id="primary-nav" data-visible="false">
      {navItems.map((item) => (
        <li class={`${styles.navItem} nav-item`}>
          <a
            href={item.href}
            data-translate={item.key}
            class={`${styles.navLink} nav-link ${isActive(item.href) ? styles.active : ""}`}
            aria-current={isActive(item.href) ? "page" : undefined}
          >
            {item.label}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</header>

<script>
  const setupNavigation = () => {
    const header = document.querySelector('#main-header');
    const hamburger = document.querySelector('.hamburger');
    const navLinks = document.querySelector('#primary-nav');
    
    if (!hamburger || !navLinks || !header) return;

    hamburger.addEventListener('click', (e) => {
      e.stopPropagation(); // Предотвращаем всплытие, чтобы не триггерить другие клики
      const isExpanded = hamburger.getAttribute('aria-expanded') === 'true';
      const newState = !isExpanded;

      // ARIA и видимость
      hamburger.setAttribute('aria-expanded', String(newState));
      navLinks.setAttribute('data-visible', String(newState));
      
      // Блокируем скролл и добавляем класс открытого меню хедеру
      if (newState) {
        document.body.style.overflow = 'hidden';
        header.classList.add('menu-open');
      } else {
        document.body.style.overflow = '';
        header.classList.remove('menu-open');
      }
    });

    // Закрываем меню при клике на ссылку
    navLinks.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        hamburger.setAttribute('aria-expanded', 'false');
        navLinks.setAttribute('data-visible', 'false');
        document.body.style.overflow = '';
        header.classList.remove('menu-open');
      });
    });
  };

  setupNavigation();
  document.addEventListener('astro:after-swap', setupNavigation);
</script>